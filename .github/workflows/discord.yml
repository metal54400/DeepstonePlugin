name: Discord annonces

on:
  push:
    branches: ["main", "master"]
  release:
    types: [published]

jobs:
  discord:
    runs-on: ubuntu-latest
    steps:
      - name: Envoyer message Discord
        shell: bash
        run: |
          WEBHOOK_URL="https://discord.com/api/webhooks/1470481645449510946/46pIUNdqayUcEzrANvUyFhyuWXuJaetAfywveyr1mTScLOF762-oWoe3Ye-tk40GCihO"

          if [ "${{ github.event_name }}" = "push" ]; then
            AUTHOR="${{ github.actor }}"
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            COMMIT_URL="${{ github.event.head_commit.url }}"

            # $'...' transforme \n en VRAI saut de ligne
            CONTENT=$'üîß **Nouveau commit sur DeepstonePlugin**\n'
            CONTENT+=$'üë§ '"$AUTHOR"$'\n'
            CONTENT+=$'üìù '"$COMMIT_MSG"$'\n'
            CONTENT+=$'üîó '"$COMMIT_URL"
          fi

          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            URL="${{ github.event.release.html_url }}"
            CHANGELOG="${{ github.event.release.body }}"

            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="(pas de d√©tails)"
            fi

            CONTENT=$'üì¢ **Nouvelle mise √† jour du plugin DeepstonePlugin**\n\n'
            CONTENT+=$'üß© Version : '"$VERSION"$'\n'
            CONTENT+=$'üìù Changelog :\n'"$CHANGELOG"$'\n\n'
            CONTENT+=$'üîó '"$URL"
          fi

          PAYLOAD=$(jq -n --arg content "$CONTENT" '{content: $content}')

          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$WEBHOOK_URL
