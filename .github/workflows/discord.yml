name: Discord annonces

on:
  push:
    branches: ["main", "master"]
  release:
    types: [published]

jobs:
  discord:
    runs-on: ubuntu-latest
    steps:
      - name: Envoyer message Discord
        shell: bash
        run: |
          WEBHOOK_URL="https://discord.com/api/webhooks/TON_ID/TON_TOKEN"

          if [ "${{ github.event_name }}" = "push" ]; then
            AUTHOR="${{ github.actor }}"
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            COMMIT_URL="${{ github.event.head_commit.url }}"

            CONTENT="ğŸ”§ **Nouveau commit sur DeepstonePlugin**
ğŸ‘¤ $AUTHOR
ğŸ“ $COMMIT_MSG
ğŸ”— $COMMIT_URL"
          fi

          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            URL="${{ github.event.release.html_url }}"
            CHANGELOG="${{ github.event.release.body }}"

            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="(pas de dÃ©tails)"
            fi

            CONTENT="ğŸ“¢ **Nouvelle mise Ã  jour du plugin DeepstonePlugin**

ğŸ§© Version : $VERSION
ğŸ“ Changelog :
$CHANGELOG

ğŸ”— $URL"
          fi

          PAYLOAD=$(jq -n --arg content "$CONTENT" '{content: $content}')

          curl -sS -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$WEBHOOK_URL"
