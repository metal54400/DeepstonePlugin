name: Discord annonces

on:
  push:
    branches: ["main", "master"]
  release:
    types: [published]

jobs:
  discord:
    runs-on: ubuntu-latest
    steps:
      - name: Envoyer message Discord
        shell: bash
        run: |
          WEBHOOK_URL="https://discord.com/api/webhooks/1470481645449510946/46pIUNdqayUcEzrANvUyFhyuWXuJaetAfywveyr1mTScLOF762-oWoe3Ye-tk40GCihO"

          if [ "${{ github.event_name }}" = "push" ]; then
            AUTHOR="${{ github.actor }}"
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            COMMIT_URL="${{ github.event.head_commit.url }}"

            CONTENT=$(cat <<EOFðŸ”§ **Nouveau commit sur DeepstonePlugin**/n
                                ðŸ‘¤ $AUTHOR
                                ðŸ“ $COMMIT_MSG
                                ðŸ”— $COMMIT_URL
                                EOF
                                )
                                          fi
                                
                                          if [ "${{ github.event_name }}" = "release" ]; then
                                            VERSION="${{ github.event.release.tag_name }}"
                                            URL="${{ github.event.release.html_url }}"
                                            CHANGELOG="${{ github.event.release.body }}"
                                
                                            [ -z "$CHANGELOG" ] && CHANGELOG="(pas de dÃ©tails)"
                                
                                            CONTENT=$(cat <<EOF
                                ðŸ“¢ **Nouvelle mise Ã  jour du plugin DeepstonePlugin**
                                
                                ðŸ§© Version : $VERSION
                                ðŸ“ Changelog :
                                $CHANGELOG
                                
                                ðŸ”— $URL
                                EOF
                                )
                  fi

          PAYLOAD=$(jq -n --arg content "$CONTENT" '{content: $content}')

          curl -sS -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$WEBHOOK_URL"
