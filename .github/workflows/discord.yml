name: Build + Discord + Draft Release

on:
  push:
    branches: ["main", "master"]

  release:
    types: [published]

  workflow_dispatch:
    inputs:
      version:
        description: "Tag/release (ex: v1.2.3)"
        required: true
      prerelease:
        description: "Release en prerelease ? (true/false)"
        required: false
        default: "false"
      upload_jar:
        description: "Attacher le jar build/libs √† la release ? (true/false)"
        required: false
        default: "true"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle (cache)
        uses: gradle/actions/setup-gradle@v3

      # Fix permission denied + √©ventuel CRLF
      - name: Prepare Gradle Wrapper
        shell: bash
        run: |
          # Si gradlew n'a pas les bons droits
          chmod +x ./gradlew

          # Si gradlew a des fins de ligne Windows (CRLF), √ßa peut casser sur Linux
          # Cette commande ne casse rien si d√©j√† OK
          sed -i 's/\r$//' ./gradlew

      - name: Build (Gradle)
        run: ./gradlew clean build

      - name: Upload artifact (JAR)
        uses: actions/upload-artifact@v4
        with:
          name: jar
          path: build/libs/*.jar
          if-no-files-found: error

  draft_release:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.event_name == 'workflow_dispatch' && needs.build.result == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download jar artifact
        if: ${{ inputs.upload_jar == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: jar
          path: dist

      - name: Create tag + Draft release (with notes)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ inputs.version }}
          PRERELEASE: ${{ inputs.prerelease }}
          UPLOAD_JAR: ${{ inputs.upload_jar }}
        shell: bash
        run: |
          set -euo pipefail

          # V√©rifie si le tag existe d√©j√† (local ou remote)
          if git ls-remote --tags origin | grep -q "refs/tags/$VERSION$"; then
            echo "Le tag $VERSION existe d√©j√† sur origin. Abandon."
            exit 1
          fi

          args=( "$VERSION" --draft --generate-notes )

          if [ "$PRERELEASE" = "true" ]; then
            args+=( --prerelease )
          fi

          if [ "$UPLOAD_JAR" = "true" ]; then
            ls -la dist
            # Si tu veux cibler un jar pr√©cis, remplace dist/*.jar par un pattern plus strict
            args+=( dist/*.jar )
          fi

          gh release create "${args[@]}"

  discord:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ (github.event_name == 'push' || github.event_name == 'release') && needs.build.result == 'success' }}
    steps:
      - name: Envoyer message Discord
        shell: bash
        run: |
          set -euo pipefail

          WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}"
          if [ -z "$WEBHOOK_URL" ]; then
            echo "Secret DISCORD_WEBHOOK_URL manquant."
            exit 1
          fi

          if [ "${{ github.event_name }}" = "push" ]; then
            AUTHOR="${{ github.actor }}"
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            COMMIT_URL="${{ github.event.head_commit.url }}"

            CONTENT="$(printf '%s\n' \
              "‚úÖ **Build OK ‚Äî Nouveau commit sur DeepstonePlugin**" \
              "üë§ $AUTHOR" \
              "üìù $COMMIT_MSG" \
              "üîó $COMMIT_URL")"
          fi

          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            URL="${{ github.event.release.html_url }}"
            CHANGELOG="${{ github.event.release.body }}"
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="(pas de d√©tails)"
            fi

            CONTENT="$(printf '%s\n' \
              "‚úÖ **Build OK ‚Äî Release publi√©e : DeepstonePlugin**" \
              "" \
              "üß© Version : $VERSION" \
              "üìù Notes :" \
              "$CHANGELOG" \
              "" \
              "üîó $URL")"
          fi

          PAYLOAD=$(jq -n --arg content "$CONTENT" '{content: $content}')

          curl -sS -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$WEBHOOK_URL"
