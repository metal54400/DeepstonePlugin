name: Build + Discord + Draft Release (Gradle version)

on:
  push:
    branches: ["main", "master"]

  release:
    types: [published]

  workflow_dispatch:
    inputs:
      prerelease:
        description: "Release en prerelease ? (true/false)"
        required: false
        default: "false"
      upload_jar:
        description: "Attacher le jar build/libs √† la release ? (true/false)"
        required: false
        default: "true"
      tag_prefix_v:
        description: "Pr√©fixer le tag par 'v' ? (true/false)"
        required: false
        default: "true"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      gradle_version: ${{ steps.getver.outputs.gradle_version }}
      tag_version: ${{ steps.getver.outputs.tag_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle (cache)
        uses: gradle/actions/setup-gradle@v3

      - name: Prepare Gradle Wrapper
        shell: bash
        run: |
          chmod +x ./gradlew
          # Corrige CRLF si le fichier vient de Windows
          sed -i 's/\r$//' ./gradlew

      # IMPORTANT: ajoute la t√¢che printVersion dans build.gradle/build.gradle.kts (voir plus bas)
      - name: Get version from Gradle
        id: getver
        shell: bash
        run: |
          set -euo pipefail

          V="$(./gradlew -q printVersion | tail -n 1 | tr -d '[:space:]')"
          if [ -z "$V" ]; then
            echo "Version Gradle vide. V√©rifie la t√¢che printVersion."
            exit 1
          fi

          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.tag_prefix_v }}" = "true" ]; then
            TAG="v$V"
          else
            # Sur push/release on garde aussi un TAG coh√©rent (utile pour logs)
            # (si tu veux toujours v, remplace par TAG="v$V")
            TAG="$V"
            if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
              TAG="v$V"
            fi
          fi

          echo "gradle_version=$V" >> "$GITHUB_OUTPUT"
          echo "tag_version=$TAG" >> "$GITHUB_OUTPUT"

          echo "Gradle version: $V"
          echo "Tag version: $TAG"

      - name: Build (Gradle)
        run: ./gradlew clean build

      - name: Upload artifact (JAR)
        uses: actions/upload-artifact@v4
        with:
          name: jar
          path: build/libs/*.jar
          if-no-files-found: error

  draft_release:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.event_name == 'workflow_dispatch' && needs.build.result == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download jar artifact
        if: ${{ inputs.upload_jar == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: jar
          path: dist

      - name: Check if tag already exists (ignore if yes)
        id: tagcheck
        shell: bash
        env:
          TAG: ${{ needs.build.outputs.tag_version }}
        run: |
          set -euo pipefail
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG$"; then
            echo "Tag $TAG existe d√©j√† ‚Üí on ignore (pas d'erreur)."
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create tag + Draft release (from Gradle version)
        if: ${{ steps.tagcheck.outputs.exists != 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.build.outputs.tag_version }}
          PRERELEASE: ${{ inputs.prerelease }}
          UPLOAD_JAR: ${{ inputs.upload_jar }}
        shell: bash
        run: |
          set -euo pipefail

          args=( "$TAG" --draft --generate-notes )

          if [ "$PRERELEASE" = "true" ]; then
            args+=( --prerelease )
          fi

          if [ "$UPLOAD_JAR" = "true" ]; then
            ls -la dist
            # Si tu veux un jar pr√©cis, remplace par ex: dist/*-all.jar ou dist/*-shadow.jar
            args+=( dist/*.jar )
          fi

          gh release create "${args[@]}"

      - name: Done (tag existed)
        if: ${{ steps.tagcheck.outputs.exists == 'true' }}
        run: echo "Rien √† faire : tag d√©j√† existant."

  discord:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ (github.event_name == 'push' || github.event_name == 'release') && needs.build.result == 'success' }}
    steps:
      - name: Envoyer message Discord
        shell: bash
        run: |
          set -euo pipefail

          WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}"
          if [ -z "$WEBHOOK_URL" ]; then
            echo "Secret DISCORD_WEBHOOK_URL manquant."
            exit 1
          fi

          if [ "${{ github.event_name }}" = "push" ]; then
            AUTHOR="${{ github.actor }}"
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            COMMIT_URL="${{ github.event.head_commit.url }}"
            VERSION="${{ needs.build.outputs.gradle_version }}"

            CONTENT="$(printf '%s\n' \
              "‚úÖ **Build OK ‚Äî DeepstonePlugin**" \
              "üß© Version (Gradle) : $VERSION" \
              "üë§ $AUTHOR" \
              "üìù $COMMIT_MSG" \
              "üîó $COMMIT_URL")"
          fi

          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            URL="${{ github.event.release.html_url }}"
            CHANGELOG="${{ github.event.release.body }}"
            [ -z "$CHANGELOG" ] && CHANGELOG="(pas de d√©tails)"

            CONTENT="$(printf '%s\n' \
              "‚úÖ **Release publi√©e : DeepstonePlugin**" \
              "üß© Version : $VERSION" \
              "" \
              "üìù Notes :" \
              "$CHANGELOG" \
              "" \
              "üîó $URL")"
          fi

          PAYLOAD=$(jq -n --arg content "$CONTENT" '{content: $content}')
          curl -sS -H "Content-Type: application/json" -d "$PAYLOAD" "$WEBHOOK_URL"
